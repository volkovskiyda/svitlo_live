blueprint:
  name: "Svitlo Live: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push –∫–æ–ª–∏ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ –∞–±–æ –∑–∞–≤—Ç—Ä–∞"
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live

  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live

    schedule_updated_sensor:
      name: –°–µ–Ω—Å–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–û–±–µ—Ä—ñ—Ç—å sensor 'Schedule updated' –¥–ª—è —Ü—å–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è)"
      selector:
        entity:
          domain: sensor
          integration: svitlo_live

    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true

    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫
      default: "‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó!"
      selector:
        text:

    location_name:
      name: –õ–æ–∫–∞—Ü—ñ—è
      default: "–î—ñ–º"
      selector:
        text:

    storage_helper:
      name: Helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      description: "–í–∏–±–µ—Ä—ñ—Ç—å Text helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —Ü—å–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
      selector:
        entity:
          domain: input_text

    text_output:
      name: Text helper –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–°—é–¥–∏ –±—É–¥–µ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏—Å—å –≥–æ—Ç–æ–≤–∏–π —Ç–µ–∫—Å—Ç —Ä–æ–∑–∫–ª–∞–¥—É (–¥–ª—è Markdown/Telegram)"
      selector:
        entity:
          domain: input_text

    send_persistent_notification:
      name: –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ persistent_notification –≤ HA
      default: true
      selector:
        boolean:

    send_on_first_run:
      name: –ù–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
      description: "–Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ ‚Äì —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏–π–¥–µ –Ω–∞–≤—ñ—Ç—å –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É, –∫–æ–ª–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø—ñ–¥–ø–∏—Å—É —â–µ –Ω–µ–º–∞—î."
      default: true
      selector:
        boolean:

mode: restart

variables:
  cal_entity: !input schedule_calendar
  mobile_targets: !input mobile_targets
  title_text: !input title_text
  location_name: !input location_name
  storage_helper: !input storage_helper
  text_output: !input text_output
  send_persistent_notification: !input send_persistent_notification
  send_on_first_run: !input send_on_first_run

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  - condition: time
    after: "05:00:00"
    before: "23:40:00"

action:
  # 1) –ü–æ–¥—ñ—ó –∑ 00:00 —Å—å–æ–≥–æ–¥–Ω—ñ –¥–æ 23:59:59 –∑–∞–≤—Ç—Ä–∞
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ (today_at('00:00') + timedelta(days=2) - timedelta(seconds=1)).isoformat() }}"
    response_variable: cal_resp

  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}

      # –ö–æ–º–ø—Ä–æ–º—ñ—Å–Ω–∏–π –Ω–∞–¥—ñ–π–Ω–∏–π –ø—ñ–¥–ø–∏—Å: yymmddHHMM start+end –¥–ª—è –∫–æ–∂–Ω–æ—ó –ø–æ–¥—ñ—ó
      schedule_signature: >-
        {%- set ns = namespace(sig='') -%}
        {%- for e in raw_events -%}
          {%- set s = as_datetime(e.start).strftime('%y%m%d%H%M') -%}
          {%- set t = as_datetime(e.end).strftime('%y%m%d%H%M') -%}
          {%- set ns.sig = ns.sig ~ s ~ t -%}
        {%- endfor -%}
        {{ ("c=" ~ (raw_events|count|string) ~ ";" ~ ns.sig) | trim }}

      old_signature: "{{ states(storage_helper) | default('') }}"

      changed: >-
        {% if send_on_first_run %}
          {{ schedule_signature[-255:] != old_signature }}
        {% else %}
          {{ schedule_signature[-255:] != old_signature and old_signature != '' }}
        {% endif %}

  - if:
      - condition: template
        value_template: "{{ changed }}"
    then:
      - variables:
          events_today: >-
            {% set today = now().astimezone(now().tzinfo).date() %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% if as_datetime(e.start).astimezone(now().tzinfo).date() == today %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          events_tomorrow: >-
            {% set tomorrow = (now().astimezone(now().tzinfo) + timedelta(days=1)).date() %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% if as_datetime(e.start).astimezone(now().tzinfo).date() == tomorrow %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          body: >-
            üìç {{ location_name }}

            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}): ‚ö° —Å–≤—ñ—Ç–ª–æ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- endif %}

          body_text: |-
            üìç {{ location_name }}

            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}): ‚ö° —Å–≤—ñ—Ç–ª–æ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- endif %}

      - repeat:
          for_each: !input mobile_targets
          sequence:
            - variables:
                svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
            - service: "{{ svc }}"
              data:
                title: "{{ title_text }}"
                message: "{{ body }}"
                data:
                  priority: high
                  tag: svitlo_changed
                  notification_icon: mdi:calendar-alert

      - if:
          - condition: template
            value_template: "{{ send_persistent_notification }}"
        then:
          - service: persistent_notification.create
            data:
              title: "{{ title_text }}"
              message: "{{ body }}"
              notification_id: svitlo_changed

      - service: input_text.set_value
        target:
          entity_id: !input text_output
        data:
          value: "{{ body_text }}"

  # 4) –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—ñ–¥–ø–∏—Å (–æ–±—Ä—ñ–∑–∞–Ω–Ω—è –¥–æ 255 –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –¥–æ–≤–≥–∏—Ö –¥–Ω—ñ–≤)
  - service: input_text.set_value
    target:
      entity_id: !input storage_helper
    data:
      value: "{{ schedule_signature[-255:] }}"
