blueprint:
  name: "Svitlo Live: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è + Telegram"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push —Ç–∞ Telegram –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∫–æ–ª–∏ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≥—Ä–∞—Ñ—ñ–∫. –§—ñ–ª—å—Ç—Ä—É—î –º–∏–Ω—É–ª—ñ –ø–æ–¥—ñ—ó –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–Ω—è."
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live

  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live

    schedule_updated_sensor:
      name: –°–µ–Ω—Å–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–û–±–µ—Ä—ñ—Ç—å sensor 'Schedule updated' –¥–ª—è —Ü—å–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É"
      selector:
        entity:
          domain: sensor
          integration: svitlo_live

    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (HA App)
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true

    telegram_chat_id:
      name: Telegram Chat ID
      description: "–í–∫–∞–∂—ñ—Ç—å ID —á–∞—Ç—É –∞–±–æ –≥—Ä—É–ø–∏ (–¥–ª—è –≥—Ä—É–ø –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ -100...). –ó–∞–ª–∏—à—Ç–µ –ø—É—Å—Ç–∏–º, —è–∫—â–æ Telegram –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω."
      default: ""
      selector:
        text:

    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫
      default: "‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó!"
      selector:
        text:

    location_name:
      name: –õ–æ–∫–∞—Ü—ñ—è
      default: "–î—ñ–º"
      selector:
        text:

    storage_helper:
      name: Helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      description: "–í–∏–±–µ—Ä—ñ—Ç—å Text helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —Ü—å–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
      selector:
        entity:
          domain: input_text

    text_output:
      name: Text helper –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–°—é–¥–∏ –±—É–¥–µ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏—Å—å –≥–æ—Ç–æ–≤–∏–π —Ç–µ–∫—Å—Ç —Ä–æ–∑–∫–ª–∞–¥—É"
      selector:
        entity:
          domain: input_text

    send_persistent_notification:
      name: –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ persistent_notification –≤ HA
      default: true
      selector:
        boolean:

    send_on_first_run:
      name: –ù–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
      default: true
      selector:
        boolean:

mode: restart

variables:
  cal_entity: !input schedule_calendar
  mobile_targets: !input mobile_targets
  telegram_chat_id: !input telegram_chat_id
  title_text: !input title_text
  location_name: !input location_name
  storage_helper: !input storage_helper
  text_output: !input text_output
  send_persistent_notification: !input send_persistent_notification
  send_on_first_run: !input send_on_first_run

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  - condition: time
    after: "05:00:00"
    before: "23:40:00"

action:
  # 1) –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–¥—ñ—ó
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ (today_at('00:00') + timedelta(days=2) - timedelta(seconds=1)).isoformat() }}"
    response_variable: cal_resp

  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}

      schedule_signature: >-
        {%- set ns = namespace(sig='') -%}
        {%- for e in raw_events -%}
          {%- set s = as_datetime(e.start).strftime('%y%m%d%H%M') -%}
          {%- set t = as_datetime(e.end).strftime('%y%m%d%H%M') -%}
          {%- set ns.sig = ns.sig ~ s ~ t -%}
        {%- endfor -%}
        {{ ("c=" ~ (raw_events|count|string) ~ ";" ~ ns.sig) | trim }}

      old_signature: "{{ states(storage_helper) | default('') }}"

      changed: >-
        {% if send_on_first_run %}
          {{ schedule_signature[-255:] != old_signature }}
        {% else %}
          {{ schedule_signature[-255:] != old_signature and old_signature != '' }}
        {% endif %}

  - if:
      - condition: template
        value_template: "{{ changed }}"
    then:
      - variables:
          events_today: >-
            {% set today = now().astimezone(now().tzinfo).date() %}
            {% set current_time = now().astimezone(now().tzinfo) %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% set e_start = as_datetime(e.start).astimezone(now().tzinfo) %}
              {% set e_end = as_datetime(e.end).astimezone(now().tzinfo) %}
              {# –§—ñ–ª—å—Ç—Ä: –î–∞—Ç–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—è –Ü —á–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –±—ñ–ª—å—à–µ –ø–æ—Ç–æ—á–Ω–æ–≥–æ #}
              {% if e_start.date() == today and e_end > current_time %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          events_tomorrow: >-
            {% set tomorrow = (now().astimezone(now().tzinfo) + timedelta(days=1)).date() %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% if as_datetime(e.start).astimezone(now().tzinfo).date() == tomorrow %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ (Title + Message)
          body: >-
            üìç {{ location_name }}

            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}): ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- endif %}

          # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –¢–µ–∫—Å—Ç—É/Telegram (–ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç)
          body_text: |-
            üìç {{ location_name }}

            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}): ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- endif %}

      # 2.1) –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏
      - repeat:
          for_each: !input mobile_targets
          sequence:
            - variables:
                svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
            - service: "{{ svc }}"
              data:
                title: "{{ title_text }}"
                message: "{{ body }}"
                data:
                  priority: high
                  tag: svitlo_changed
                  notification_icon: mdi:calendar-alert

      # 2.2) –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Telegram (—è–∫—â–æ –∑–∞–¥–∞–Ω–æ ID)
      - if:
          - condition: template
            value_template: "{{ telegram_chat_id != '' }}"
        then:
          - service: telegram_bot.send_message
            data:
              target: !input telegram_chat_id
              title: "{{ title_text }}"
              message: "{{ body_text }}"

      # 2.3) Persistent notification
      - if:
          - condition: template
            value_template: "{{ send_persistent_notification }}"
        then:
          - service: persistent_notification.create
            data:
              title: "{{ title_text }}"
              message: "{{ body }}"
              notification_id: svitlo_changed

      # 2.4) –ó–∞–ø–∏—Å —Ç–µ–∫—Å—Ç—É –≤ helper
      - service: input_text.set_value
        target:
          entity_id: !input text_output
        data:
          value: "{{ body_text }}"

  # 4) –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—ñ–¥–ø–∏—Å
  - service: input_text.set_value
    target:
      entity_id: !input storage_helper
    data:
      value: "{{ schedule_signature[-255:] }}"
