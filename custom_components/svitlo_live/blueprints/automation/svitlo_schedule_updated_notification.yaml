blueprint:
  name: "Svitlo Live: Ð¡Ð¿Ð¾Ð²Ñ–Ñ‰ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð³Ñ€Ð°Ñ„Ñ–ÐºÑ–Ð²"
  description: "ÐÐ°Ð´ÑÐ¸Ð»Ð°Ñ” push ÐºÐ¾Ð»Ð¸ Ð¾Ð½Ð¾Ð²Ð»ÑŽÑ”Ñ‚ÑŒÑÑ Ð³Ñ€Ð°Ñ„Ñ–ÐºÑ–Ð² Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÐµÐ»ÐµÐºÑ‚Ñ€Ð¾Ð¿Ð¾ÑÑ‚Ð°Ñ‡Ð°Ð½Ð½Ñ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ– Ð°Ð±Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð°"
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live
  input:
    schedule_calendar:
      name: ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live

    schedule_updated_sensor:
      name: Ð¡ÐµÐ½ÑÐ¾Ñ€ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ€Ð¾Ð·ÐºÐ»Ð°Ð´Ñƒ
      description: "ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ sensor 'Schedule updated' Ð´Ð»Ñ Ñ†ÑŒÐ¾Ð³Ð¾ Ñ€ÐµÐ³Ñ–Ð¾Ð½Ñƒ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ñ„Ñ–Ð»ÑŒÑ‚Ñ€ÑƒÑ”Ñ‚ÑŒÑÑ)"
      selector:
        entity:
          domain: sensor
          integration: svitlo_live

    mobile_targets:
      name: ÐœÐ¾Ð±Ñ–Ð»ÑŒÐ½Ñ– Ð¿Ñ€Ð¸ÑÑ‚Ñ€Ð¾Ñ—
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true

    title_text:
      name: Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
      default: "âš ï¸ ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ¸ Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ÑŒ ÐµÐ»ÐµÐºÑ‚Ñ€Ð¾ÐµÐ½ÐµÑ€Ð³Ñ–Ñ—!"
      selector:
        text:

    storage_helper:
      name: Helper Ð´Ð»Ñ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ
      description: "Ð’Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ Text helper Ð´Ð»Ñ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ ÑÑ‚Ð°Ð½Ñƒ Ñ†ÑŒÐ¾Ð³Ð¾ ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ñ"
      selector:
        entity:
          domain: input_text

mode: restart

variables:
  cal_entity: !input schedule_calendar
  mobile_targets: !input mobile_targets
  title_text: !input title_text
  storage_helper: !input storage_helper
  # Ð’Ð¸Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ Ð½Ð°Ð·Ð²Ñƒ Ñ€ÐµÐ³Ñ–Ð¾Ð½Ñƒ Ñ‚Ð° Ñ‡ÐµÑ€Ð³Ð¸ Ð· entity_id ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ñ
  region_queue: >-
    {% set parts = cal_entity.split('_') %}
    {% if parts | length >= 4 %}
      {{ parts[1] | title }} {{ parts[2] | title }}, Ñ‡ÐµÑ€Ð³Ð° {{ parts[3:] | join('.') }}
    {% else %}
      {{ cal_entity.split('.')[1] | replace('_', ' ') | title }}
    {% endif %}

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  - condition: time
    after: "05:00:00"
    before: "23:40:00"

action:
  # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ñ€Ð¾Ð·ÐºÐ»Ð°Ð´ Ð½Ð° ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ– Ñ‚Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð°
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ (today_at('00:00') + timedelta(days=2) - timedelta(seconds=1)).isoformat() }}"
    response_variable: cal_resp

  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}

      # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ hash Ñ€Ð¾Ð·ÐºÐ»Ð°Ð´Ñƒ (Ð¿Ð¾Ð²Ð½Ð¸Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚)
      schedule_signature: >-
        {% set ns = namespace(sig='') %}
        {% for e in raw_events %}
          {% set ns.sig = ns.sig ~ e.start[9:15] ~ e.end[9:15] ~ '|' %}
        {% endfor %}
        {{ ns.sig | regex_replace('[T:]', '') }}

      # ÐŸÐ¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¹ hash
      old_signature: "{{ states(storage_helper) | default('') }}"

      # Ð§Ð¸ Ð·Ð¼Ñ–Ð½Ð¸Ð»Ð¾ÑÑ?
      changed: "{{ schedule_signature != old_signature }}"

  - if:
      - condition: template
        value_template: "{{ changed }}"
    then:
      - variables:
          events_today: >-
            {% set today = now().date() %}
            {{ raw_events | selectattr('start', 'search', today.isoformat()) | list }}

          events_tomorrow: >-
            {% set tomorrow = (now() + timedelta(days=1)).date() %}
            {{ raw_events | selectattr('start', 'search', tomorrow.isoformat()) | list }}

          body: >-
            ðŸ“ {{ region_queue }}
            
            {% if events_today | length > 0 -%}
            ðŸ“… Ð¡Ð¬ÐžÐ“ÐžÐ”ÐÐ† ({{ now().strftime('%d.%m.%Y') }})
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            âŒ {{ s.strftime('%H:%M') }} â” {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- else %}
            ðŸ“… Ð¡Ð¬ÐžÐ“ÐžÐ”ÐÐ† ({{ now().strftime('%d.%m.%Y') }}):
            
            âš¡ Ð¡Ð²Ñ–Ñ‚Ð»Ð¾ Ð±ÑƒÐ´Ðµ Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ! âš¡
            {%- endif %}
            
            {% if events_tomorrow | length > 0 -%}
            ðŸ“… Ð—ÐÐ’Ð¢Ð Ð ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            
            {% for e in events_tomorrow -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            âŒ {{ s.strftime('%H:%M') }} â” {{ end.strftime('%H:%M') }}
            
            {% endfor -%}
            {%- endif %}
      - choose:
          - conditions: "{{ mobile_targets | length > 0 }}"
            sequence:
              - repeat:
                  for_each: !input mobile_targets
                  sequence:
                    - variables:
                        svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}"
                    - service: "{{ svc }}"
                      data:
                        title: "{{ title_text }}"
                        message: "{{ body }}"
                        data:
                          priority: high
                          tag: svitlo_changed
                          notification_icon: "mdi:calendar-alert"

  # Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ hash
  - service: input_text.set_value
    target:
      entity_id: !input storage_helper
    data:
      value: "{{ schedule_signature }}"
